{"version":3,"sources":["../../src/collaborative/LiveblocksCursorOverlay.tsx","../../src/collaborative/liveblocks-config.ts"],"names":["RoomProvider","useRoom","useOthers","useSelf","useStorage","useMutation","useMyPresence","useUpdateMyPresence"],"mappings":"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","file":"index.js","sourcesContent":["'use client'\r\n\r\nimport React, { useEffect, useState } from 'react'\r\nimport { useOthers } from '@liveblocks/react'\r\nimport { useEditorRef } from 'platejs/react'\r\nimport { ReactEditor } from 'slate-react'\r\n\r\ninterface LiveblocksCursorOverlayProps {\r\n  containerRef: React.RefObject<HTMLDivElement | null>\r\n}\r\n\r\nexport function LiveblocksCursorOverlay({ containerRef }: LiveblocksCursorOverlayProps) {\r\n  const others = useOthers()\r\n  const editor = useEditorRef()\r\n\r\n  return (\r\n    <div className=\"pointer-events-none absolute inset-0 z-50 overflow-hidden\">\r\n      {others.map(({ connectionId, presence, info }) => {\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        const p = presence as any\r\n        if (!p?.selection) return null\r\n\r\n        return (\r\n          <Cursor\r\n            key={connectionId}\r\n            editor={editor}\r\n            selection={p.selection}\r\n            color={p.color || '#f00'}\r\n            name={p.name || 'Anonymous'}\r\n            containerRef={containerRef}\r\n          />\r\n        )\r\n      })}\r\n    </div>\r\n  )\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nfunction Cursor({ editor, selection, color, name, containerRef }: any) {\r\n  const [position, setPosition] = useState<{ top: number; left: number; height: number } | null>(null)\r\n\r\n  useEffect(() => {\r\n    let animationFrameId: number\r\n\r\n    const updatePosition = () => {\r\n      // 检查 containerRef 是否有 current，如果没有，说明编辑器还没挂载好\r\n      if (!editor || !selection || !containerRef.current) {\r\n         // 可能在重新渲染，下一帧再试\r\n         animationFrameId = requestAnimationFrame(updatePosition)\r\n         return\r\n      }\r\n\r\n      try {\r\n        // 尝试将 Slate Range 转换为 DOM Range\r\n        // 这一步最容易失败，因为 Slate 的虚拟节点可能还没对应的 DOM\r\n        const domRange = ReactEditor.toDOMRange(editor, selection)\r\n        const rects = domRange.getClientRects()\r\n        \r\n        if (rects.length > 0) {\r\n          const rect = rects[0]\r\n          const containerRect = containerRef.current.getBoundingClientRect()\r\n          \r\n          const scrollTop = containerRef.current.scrollTop\r\n          const scrollLeft = containerRef.current.scrollLeft\r\n\r\n          // 核心修复：确保 rect 是有意义的\r\n          // 比如当 rect 全部为 0 时可能是隐藏状态\r\n          if (rect.width === 0 && rect.height === 0 && rect.x === 0 && rect.y === 0) {\r\n             // 这种情况下可能是不可见的，跳过更新\r\n          } else {\r\n              const top = rect.top - containerRect.top + scrollTop\r\n              const left = rect.left - containerRect.left + scrollLeft\r\n              \r\n              setPosition({\r\n                top,\r\n                left,\r\n                height: rect.height || 20 // 兜底高度\r\n              })\r\n          }\r\n        }\r\n      } catch (e) {\r\n        // 常见错误：Cannot find a DOM node for slate node\r\n        // 这通常发生在远程内容刚同步过来，Slate 节点树还没完全渲染成 DOM 时\r\n        // 忽略它，等待下一帧\r\n      }\r\n\r\n      animationFrameId = requestAnimationFrame(updatePosition)\r\n    }\r\n\r\n    // 启动循环\r\n    updatePosition()\r\n\r\n    return () => cancelAnimationFrame(animationFrameId)\r\n  }, [editor, selection, containerRef])\r\n\r\n  if (!position) return null\r\n\r\n  return (\r\n    <div\r\n      className=\"absolute pointer-events-none transition-all duration-100 ease-out z-[9999]\"\r\n      style={{\r\n        top: position.top,\r\n        left: position.left,\r\n        height: position.height,\r\n        // 添加一个 border 方便调试，发布时去掉\r\n        // border: `1px solid ${color}` \r\n      }}\r\n    >\r\n      {/* 光标竖线 */}\r\n      <div className=\"w-[2px] h-full shadow-sm\" style={{ backgroundColor: color }} />\r\n      \r\n      {/* 名字标签 - 调整样式确保可见 */}\r\n      <div\r\n        className=\"absolute -top-6 left-0 px-2 py-0.5 text-[10px] font-bold text-white whitespace-nowrap rounded-sm shadow-md transition-opacity duration-200\"\r\n        style={{ \r\n            backgroundColor: color,\r\n            opacity: 1 // 强制一直显示\r\n        }}\r\n      >\r\n        {name}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","'use client'\n\nimport { createClient } from '@liveblocks/client'\nimport { createRoomContext } from '@liveblocks/react'\n\n// Type definitions for editor presence and user meta\nexport type EditorPresence = {\n  cursor: { x: number; y: number } | null\n  selection: any | null\n  name: string\n  color: string\n}\n\nexport type EditorUserMeta = {\n  id: string\n  info: {\n    name: string\n    color: string\n    avatar?: string\n  }\n}\n\nexport type EditorStorage = {\n  content: string\n}\n\nexport interface LiveblocksConfig {\n  RoomProvider: ReturnType<typeof createRoomContext>['RoomProvider']\n  useRoom: ReturnType<typeof createRoomContext>['useRoom']\n  useOthers: ReturnType<typeof createRoomContext>['useOthers']\n  useSelf: ReturnType<typeof createRoomContext>['useSelf']\n  useStorage: ReturnType<typeof createRoomContext>['useStorage']\n  useMutation: ReturnType<typeof createRoomContext>['useMutation']\n  useMyPresence: ReturnType<typeof createRoomContext>['useMyPresence']\n  useUpdateMyPresence: ReturnType<typeof createRoomContext>['useUpdateMyPresence']\n}\n\n/**\n * Create Liveblocks configuration for collaborative editing\n * \n * @example\n * ```ts\n * // In your app's liveblocks.config.ts\n * import { createLiveblocksConfig } from '@susie/editor/collaborative'\n * \n * export const {\n *   RoomProvider,\n *   useRoom,\n *   useOthers,\n *   useSelf,\n *   useStorage,\n *   useMutation,\n *   useMyPresence,\n *   useUpdateMyPresence,\n * } = createLiveblocksConfig({\n *   authEndpoint: '/api/liveblocks-auth',\n * })\n * ```\n */\nexport function createLiveblocksConfig(options: {\n  authEndpoint?: string\n  publicApiKey?: string\n}): LiveblocksConfig {\n  const client = createClient({\n    authEndpoint: options.authEndpoint,\n    publicApiKey: options.publicApiKey,\n  })\n\n  const {\n    RoomProvider,\n    useRoom,\n    useOthers,\n    useSelf,\n    useStorage,\n    useMutation,\n    useMyPresence,\n    useUpdateMyPresence,\n  } = createRoomContext<EditorPresence, EditorStorage, EditorUserMeta>(client)\n\n  return {\n    RoomProvider,\n    useRoom,\n    useOthers,\n    useSelf,\n    useStorage,\n    useMutation,\n    useMyPresence,\n    useUpdateMyPresence,\n  }\n}\n"]}